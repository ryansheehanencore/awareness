<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Audio Transcription</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #transcription-container {
            text-align: center;
            width: 80%;
            max-width: 800px;
        }
        .text-line {
            transition: opacity 0.5s;
            margin: 10px 0;
            min-height: 60px;
        }
        #microphone-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border: 1px solid white;
            z-index: 1000;
        }
        #microphone-list {
            list-style: none;
            padding: 0;
        }
        #microphone-list li {
            margin: 10px 0;
            cursor: pointer;
            padding: 5px;
        }
        #microphone-list li:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div id="transcription-container">
        <div id="line1" class="text-line"></div>
        <div id="line2" class="text-line"></div>
    </div>

    <div id="microphone-modal">
        <h2>Select Microphone</h2>
        <ul id="microphone-list"></ul>
    </div>

    <script>
        let recognition;
        let fontSize = 50;
        let fadeOutTime = 500;
        let currentLine = 1;
        let fadeOutTimeout;
        let selectedMicrophoneId = null;
        let lastResult = '';
        let lastResultTime = Date.now();

        // Initialize speech recognition
        function initSpeechRecognition() {
            if (recognition) {
                recognition.stop();
            }
            
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = handleRecognitionResult;
            recognition.onend = handleRecognitionEnd;
            
            recognition.start();
        }

        function handleRecognitionResult(event) {
            clearTimeout(fadeOutTimeout);
            
            const result = event.results[event.results.length - 1];
            const transcript = result[0].transcript;
            
            if (transcript !== lastResult) {
                lastResult = transcript;
                lastResultTime = Date.now();
                
                const currentLineElement = document.getElementById(`line${currentLine}`);
                const otherLineElement = document.getElementById(`line${currentLine === 1 ? 2 : 1}`);
                
                currentLineElement.style.fontSize = `${fontSize}px`;
                currentLineElement.textContent = transcript;
                currentLineElement.style.opacity = 1;
                
                // Start fading out the other line if it has content
                if (otherLineElement.textContent) {
                    otherLineElement.style.opacity = 0;
                    setTimeout(() => {
                        otherLineElement.textContent = '';
                    }, fadeOutTime);
                }
            }

            if (result.isFinal) {
                // Switch to the other line for the next phrase
                currentLine = currentLine === 1 ? 2 : 1;
                
                // Set up fade out for the completed phrase
                fadeOutTimeout = setTimeout(() => {
                    const lineToFade = document.getElementById(`line${currentLine === 1 ? 2 : 1}`);
                    lineToFade.style.opacity = 0;
                    setTimeout(() => {
                        lineToFade.textContent = '';
                    }, fadeOutTime);
                }, 500);
            }
        }

        function handleRecognitionEnd() {
            // Restart recognition if it ends
            setTimeout(() => {
                try {
                    recognition.start();
                } catch (err) {
                    console.error('Failed to restart recognition:', err);
                    initSpeechRecognition();
                }
            }, 1000);
        }

        // Handle microphone selection
        async function setupMicrophoneSelection() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const microphones = devices.filter(device => device.kind === 'audioinput');
            const micList = document.getElementById('microphone-list');
            micList.innerHTML = '';

            microphones.forEach(mic => {
                const li = document.createElement('li');
                li.textContent = mic.label || `Microphone ${micList.children.length + 1}`;
                li.onclick = () => {
                    selectedMicrophoneId = mic.deviceId;
                    document.getElementById('microphone-modal').style.display = 'none';
                    initSpeechRecognition();
                };
                micList.appendChild(li);
            });
        }

        // Event listeners
        document.addEventListener('keydown', (event) => {
            switch(event.key) {
                case 'ArrowUp':
                    fontSize = Math.min(fontSize + 5, 100);
                    break;
                case 'ArrowDown':
                    fontSize = Math.max(fontSize - 5, 20);
                    break;
                case 'ArrowLeft':
                    fadeOutTime = Math.max(fadeOutTime - 100, 100);
                    break;
                case 'ArrowRight':
                    fadeOutTime = Math.min(fadeOutTime + 100, 2000);
                    break;
                case 'm':
                case 'M':
                    document.getElementById('microphone-modal').style.display = 'block';
                    setupMicrophoneSelection();
                    break;
            }
        });

        // Initialize
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(() => {
                setupMicrophoneSelection();
                initSpeechRecognition();
            })
            .catch(error => {
                console.error('Microphone access denied:', error);
            });
    </script>
</body>
</html>
