<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Transcription Display</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #transcription {
            text-align: center;
            font-size: 50px;
            opacity: 0;
            transition: opacity 1s;
            word-wrap: break-word;
            max-width: 90vw;
        }

        #message {
            position: absolute;
            text-align: center;
            font-size: 40px;
            color: gray;
            opacity: 1;
            transition: opacity 1s;
        }

        #menu {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 1s;
        }

        .visible {
            opacity: 1 !important;
        }
    </style>
</head>
<body>
    <div id="menu">Up/Down Font Size: 50 | Left/Right Fade Rate: 1000ms</div>
    <div id="message">Press '<span id="start-transcription">M</span>' to start transcription</div>
    <div id="transcription"></div>

    <script>
        let isMuted = true;
        let transcript = document.getElementById('transcription');
        let message = document.getElementById('message');
        let menu = document.getElementById('menu');
        let fontSize = 30;
        let fadeRate = 500; // Default fade rate
        let touchStartX = 0;
        let touchStartY = 0;
        let lines = []; // To store the current lines of text
        let maxLines = 3; // Maximum number of lines to display
        let interimLine = ''; // To temporarily store the interim transcript (live text)

        const updateMenu = () => {
            menu.innerHTML = `Up/Down Font Size: ${fontSize} | Left/Right Fade Rate: ${fadeRate}ms`;
            menu.classList.add('visible');
            setTimeout(() => menu.classList.remove('visible'), 2000);
        };

        const fadeOutText = () => {
            transcript.style.transition = `opacity ${fadeRate}ms`;
            transcript.style.opacity = 0;
        };

        const updateDisplay = () => {
            // Combine lines with the current interim text (live transcription)
            let displayText = [...lines, interimLine].join('<br>');
            transcript.innerHTML = displayText; // Display the combined text
            transcript.style.fontSize = `${fontSize}px`;
            transcript.style.opacity = 1;

            clearTimeout(fadeOutTimeout);
            fadeOutTimeout = setTimeout(fadeOutText, 2000); // Delay fade-out
        };

        const toSentenceCase = (str) => {
            return str.charAt(0).toUpperCase() + str.slice(1);
        };

        const handleTranscription = (event) => {
            if (!isMuted) {
                interimLine = ''; // Clear previous interim transcript
                let finalTranscript = ''; // To store the final transcript

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    let transcriptText = event.results[i][0].transcript.trim();

                    if (event.results[i].isFinal) {
                        // For final results, format the sentence and add to the permanent lines array
                        transcriptText = toSentenceCase(transcriptText);
                        finalTranscript += transcriptText + ' ';

                        // Add final transcript to the lines array
                        lines.push(finalTranscript.trim());

                        // Limit to three lines; remove the oldest if needed
                        if (lines.length > maxLines) {
                            lines.shift(); // Remove the first (oldest) line
                        }
                    } else {
                        // This is interim (live) text, so display it immediately
                        interimLine = transcriptText;
                    }
                }

                // Update the display with both final and interim text
                updateDisplay();
            }
        };

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.onresult = handleTranscription;

        let fadeOutTimeout;

        const toggleTranscription = () => {
            isMuted = !isMuted;
            if (!isMuted) {
                recognition.start();
                transcript.innerHTML = 'Listening...';
                message.style.opacity = 0;
            } else {
                recognition.stop();
                transcript.innerHTML = '';
                message.innerHTML = "Press 'M' to start transcription";
                message.style.opacity = 1;
            }
        };

        document.getElementById('start-transcription').addEventListener('click', toggleTranscription);

        window.addEventListener('keydown', (event) => {
            if (event.key.toLowerCase() === 'm') {
                toggleTranscription();
            }
        });

        window.addEventListener('touchstart', (event) => {
            touchStartX = event.touches[0].clientX;
            touchStartY = event.touches[0].clientY;
        });

        window.addEventListener('touchmove', (event) => {
            const touchEndX = event.touches[0].clientX;
            const touchEndY = event.touches[0].clientY;
            const diffX = touchEndX - touchStartX;
            const diffY = touchEndY - touchStartY;

            if (Math.abs(diffY) > Math.abs(diffX)) {
                if (diffY < 0) {
                    fontSize += 2;
                } else {
                    fontSize -= 2;
                }
                updateMenu();
            }

            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (diffX < 0) {
                    fadeRate = Math.max(500, fadeRate - 100);
                } else {
                    fadeRate += 100;
                }
                updateMenu();
            }
        });

        updateMenu();
    </script>
</body>
</html>
