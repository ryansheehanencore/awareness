<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Audio Transcription</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #transcription-container {
            text-align: center;
            width: 80%;
            max-width: 800px;
        }
        .text-line {
            min-height: 60px;
            position: relative;
            margin: 10px 0;
        }
        .text-content {
            position: absolute;
            width: 100%;
            left: 0;
            transition: opacity 1s;
            opacity: 0;
        }
        .word {
            display: inline-block;
            opacity: 0;
            transition: opacity 0.15s;
        }
        #microphone-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border: 1px solid white;
            z-index: 1000;
        }
        #microphone-list {
            list-style: none;
            padding: 0;
        }
        #microphone-list li {
            margin: 10px 0;
            cursor: pointer;
            padding: 5px;
        }
        #microphone-list li:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div id="transcription-container">
        <div id="line1" class="text-line">
            <div class="text-content"></div>
        </div>
        <div id="line2" class="text-line">
            <div class="text-content"></div>
        </div>
    </div>

    <div id="microphone-modal">
        <h2>Select Microphone</h2>
        <ul id="microphone-list"></ul>
    </div>

    <script>
        let recognition;
        let fontSize = 50;
        let fadeOutDelay = 500;
        let fadeOutDuration = 1000;
        let currentLine = 1;
        let fadeOutTimeout;
        let selectedMicrophoneId = null;
        let lastProcessedIndex = 0;

        function initSpeechRecognition() {
            if (recognition) {
                recognition.stop();
            }
            
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = handleRecognitionResult;
            recognition.onend = handleRecognitionEnd;
            
            recognition.start();
        }

        function handleRecognitionResult(event) {
            clearTimeout(fadeOutTimeout);
            
            const result = event.results[event.results.length - 1];
            const transcript = result[0].transcript;
            
            const currentLineElement = document.querySelector(`#line${currentLine} .text-content`);
            const otherLineElement = document.querySelector(`#line${currentLine === 1 ? 2 : 1} .text-content`);
            
            currentLineElement.style.fontSize = `${fontSize}px`;
            
            // Split transcript into words and create/update word spans
            const words = transcript.split(' ');
            let html = '';
            words.forEach((word, index) => {
                html += `<span class="word">${word} </span>`;
            });
            currentLineElement.innerHTML = html;
            
            // Fade in new words
            const wordElements = currentLineElement.querySelectorAll('.word');
            wordElements.forEach((wordEl, index) => {
                if (index >= lastProcessedIndex) {
                    setTimeout(() => {
                        wordEl.style.opacity = 1;
                    }, 50 * (index - lastProcessedIndex));
                } else {
                    wordEl.style.opacity = 1;
                }
            });
            lastProcessedIndex = wordElements.length;
            
            // Ensure the line is visible
            currentLineElement.style.opacity = 1;

            if (result.isFinal) {
                // Set up fade out for the completed phrase
                fadeOutTimeout = setTimeout(() => {
                    currentLineElement.style.transition = `opacity ${fadeOutDuration}ms`;
                    currentLineElement.style.opacity = 0;
                    
                    setTimeout(() => {
                        // Switch lines after fade out
                        currentLine = currentLine === 1 ? 2 : 1;
                        lastProcessedIndex = 0;
                    }, fadeOutDuration);
                }, fadeOutDelay);
            }
        }

        function handleRecognitionEnd() {
            setTimeout(() => {
                try {
                    recognition.start();
                } catch (err) {
                    console.error('Failed to restart recognition:', err);
                    initSpeechRecognition();
                }
            }, 1000);
        }

        async function setupMicrophoneSelection() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const microphones = devices.filter(device => device.kind === 'audioinput');
            const micList = document.getElementById('microphone-list');
            micList.innerHTML = '';

            microphones.forEach(mic => {
                const li = document.createElement('li');
                li.textContent = mic.label || `Microphone ${micList.children.length + 1}`;
                li.onclick = () => {
                    selectedMicrophoneId = mic.deviceId;
                    document.getElementById('microphone-modal').style.display = 'none';
                    initSpeechRecognition();
                };
                micList.appendChild(li);
            });
        }

        document.addEventListener('keydown', (event) => {
            switch(event.key) {
                case 'ArrowUp':
                    fontSize = Math.min(fontSize + 5, 100);
                    document.querySelectorAll('.text-content').forEach(el => {
                        el.style.fontSize = `${fontSize}px`;
                    });
                    break;
                case 'ArrowDown':
                    fontSize = Math.max(fontSize - 5, 20);
                    document.querySelectorAll('.text-content').forEach(el => {
                        el.style.fontSize = `${fontSize}px`;
                    });
                    break;
                case 'ArrowLeft':
                    fadeOutDuration = Math.max(fadeOutDuration - 100, 500);
                    break;
                case 'ArrowRight':
                    fadeOutDuration = Math.min(fadeOutDuration + 100, 2000);
                    break;
                case 'm':
                case 'M':
                    document.getElementById('microphone-modal').style.display = 'block';
                    setupMicrophoneSelection();
                    break;
            }
        });

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(() => {
                setupMicrophoneSelection();
                initSpeechRecognition();
            })
            .catch(error => {
                console.error('Microphone access denied:', error);
            });
    </script>
</body>
</html>
